stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: $DOCKER_USERNAME/assistant

# Build and push Docker image
build-and-push:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  only:
    - master
  script:
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    - docker build -t "$DOCKER_IMAGE:$CI_COMMIT_SHA" -t "$DOCKER_IMAGE:latest" .
    - docker push "$DOCKER_IMAGE:$CI_COMMIT_SHA"
    - docker push "$DOCKER_IMAGE:latest"

# Deploy to VPS
deploy:
  stage: deploy
  image: alpine:latest
  only:
    - master
  needs:
    - build-and-push
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null" > ~/.ssh/config
  script:
    # Copy docker-compose.yml to VPS
    - scp docker-compose.yml "$VPS_USER@$VPS_HOST:/home/$VPS_USER/assistant/"
    
    # Deploy via SSH
    - |
      ssh "$VPS_USER@$VPS_HOST" << 'EOF'
        cd /home/$VPS_USER/assistant
        
        # Stop containers first
        docker compose down || true
        
        # Create .env from secret
        echo "$ENV_FILE" > .env
        
        # Remove old credentials.json
        rm -rf credentials.json
        
        # Create credentials.json from secret
        echo '$GOOGLE_CREDENTIALS' > credentials.json
        
        # Login to Docker Hub
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        
        # Pull and restart
        docker compose pull
        docker compose up -d --remove-orphans
        
        # Cleanup
        docker image prune -f
      EOF
    
    # Health check
    - sleep 30
    - curl -f "http://$VPS_HOST:8000/health" || echo "Health check failed"
  allow_failure: false
